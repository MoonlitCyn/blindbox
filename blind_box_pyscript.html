<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç›²ç›’æ­Œå•ï¼ˆçº¯æµè§ˆå™¨ç‰ˆÂ·PyScriptï¼‰</title>
  <!-- PyScriptï¼ˆéœ€è”ç½‘åŠ è½½è¿è¡Œæ—¶ï¼›é¦–æ¬¡åŠ è½½åä¼šç¼“å­˜ï¼‰ -->
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <style>
    :root { --gap: 12px; --radius: 14px; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
           margin: 0; background: #0f172a; color: #e2e8f0; }
    .wrap { max-width: 840px; margin: 0 auto; padding: 20px 14px 80px; }
    h1 { font-size: 22px; margin: 8px 0 10px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: var(--radius);
            padding: 14px; margin-top: var(--gap); }
    label { font-size: 14px; opacity: .9; margin-bottom: 6px; display: block; }
    input[type="text"], input[type="number"], textarea, select {
      width: 100%; background: #0b1220; color: #e2e8f0; border: 1px solid #233044;
      border-radius: 10px; padding: 10px; outline: none;
    }
    textarea { min-height: 110px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr; gap: var(--gap); }
    @media (min-width: 720px) { .row-2 { grid-template-columns: 1fr 1fr; } }
    button {
      background: #2563eb; color: #fff; border: none; border-radius: 10px;
      padding: 10px 14px; font-weight: 600;
    }
    button.secondary { background: #374151; }
    button.warn { background: #dc2626; }
    .muted { color: #94a3b8; font-size: 13px; }
    .pill { display:inline-block;background:#0b1220;border:1px solid #233044;border-radius:999px;padding:4px 10px;font-size:12px;color:#9fb7d3 }
    .flex { display:flex; gap: var(--gap); align-items: center; flex-wrap: wrap; }
    .spacer { height: 6px; }
    .success { color:#34d399 }
    .hr { height:1px; background:#1f2937; margin: 10px 0; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
           background:#0b1220;border:1px solid #233044;border-radius:6px;padding:2px 6px;font-size:12px; }
    .num { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸµ ç›²ç›’æ­Œå•ï¼ˆçº¯æµè§ˆå™¨ç‰ˆÂ·PyScriptï¼‰</h1>
  <div class="muted">åœ¨æ‰‹æœº/å¹³æ¿/ç”µè„‘çš„æµè§ˆå™¨ä¸­ç›´æ¥è¿è¡Œã€‚æ·»åŠ /åˆ é™¤æ­Œæ›²ï¼Œç¼–å· 1..N å¼€ç›²ç›’ï¼›æ¯æ¬¡æ´—ç‰Œéƒ½ä¼šæ‰“ä¹±ç¼–å·â†’æ­Œåæ˜ å°„ã€‚</div>

  <!-- æ­Œæ›²æ± ä¸æ§åˆ¶ -->
  <div class="card">
    <div class="flex">
      <div class="pill">æ­Œæ›²æ•°ï¼š<span id="song-count" class="num">0</span></div>
      <div class="pill">æœ€è¿‘æ´—ç‰Œï¼š<span id="last-shuffle" class="num">â€”</span></div>
    </div>
    <div class="spacer"></div>
    <div class="row row-2">
      <div>
        <label>è¾“å…¥ä¸€ä¸ªæ•°å­—ï¼ˆ1..Nï¼‰å¼€ç›²ç›’</label>
        <input id="pick-number" type="number" min="1" value="1" />
      </div>
      <div class="flex">
        <button id="btn-open">æ‰“å¼€ç›²ç›’</button>
        <button id="btn-random" class="secondary">éšæœºæŠ½ä¸€é¦–</button>
        <button id="btn-shuffle">é‡æ–°æ´—ç‰Œ</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div id="result" class="success"></div>
  </div>

  <!-- æ·»åŠ /åˆ é™¤ -->
  <div class="row row-2">
    <div class="card">
      <label>æ·»åŠ å•æ›²</label>
      <input id="single-title" type="text" placeholder="ä¾‹å¦‚ï¼šå‘¨æ°ä¼¦ - æ™´å¤©" />
      <div class="spacer"></div>
      <button id="btn-add-single">æ·»åŠ </button>
      <div class="spacer"></div>
      <div class="muted">ä¼šè‡ªåŠ¨å»é‡ï¼›ä¸åŒºåˆ†å¤§å°å†™ã€‚</div>
    </div>
    <div class="card">
      <label>æ‰¹é‡æ·»åŠ ï¼ˆæ¯è¡Œæˆ–ç”¨é€—å·åˆ†éš”ï¼‰</label>
      <textarea id="bulk-titles" placeholder="æ­ŒåA\næ­ŒåB, æ­ŒåC"></textarea>
      <div class="spacer"></div>
      <button id="btn-add-bulk">æ‰¹é‡æ·»åŠ </button>
    </div>
  </div>

  <div class="card">
    <label>åˆ é™¤æ­Œæ›²ï¼ˆå¯å¤šé€‰ï¼‰</label>
    <select id="delete-select" multiple size="8"></select>
    <div class="spacer"></div>
    <button id="btn-delete" class="warn">åˆ é™¤æ‰€é€‰</button>
  </div>

  <!-- å¯¼å…¥ / å¯¼å‡º -->
  <div class="row row-2">
    <div class="card">
      <label>å¯¼å‡º JSON</label>
      <button id="btn-export" class="secondary">å¯¼å‡º songs.json</button>
      <div class="spacer"></div>
      <div class="muted">æ ¼å¼ï¼š<span class="kbd">{"songs": ["æ­Œå1", ...]}</span> æˆ– <span class="kbd">["æ­Œå1", ...]</span></div>
    </div>
    <div class="card">
      <label>å¯¼å…¥ JSON</label>
      <input id="import-file" type="file" accept="application/json" />
      <div class="spacer"></div>
      <div class="muted">å¯¼å…¥ä¼šè¦†ç›–å½“å‰æ­Œå•ï¼ˆä¼šè‡ªåŠ¨è½¬æ¢ä¸ºä¸é‡å¤åˆ—è¡¨ï¼‰ã€‚</div>
    </div>
  </div>

  <div class="card">
    <details>
      <summary>ä½¿ç”¨è¯´æ˜</summary>
      <div class="hr"></div>
      <ul>
        <li>ç‚¹å‡»â€œé‡æ–°æ´—ç‰Œâ€ä¼šéšæœºæ‰“ä¹± <b>æ•°å­— 1..N</b> ä¸ <b>æ­Œå</b> çš„å¯¹åº”å…³ç³»ï¼Œå¹¶è®°å½•æ—¶é—´ã€‚</li>
        <li>è¾“å…¥æ•°å­—å¼€ç›²ç›’ï¼›æˆ–ç‚¹â€œéšæœºæŠ½ä¸€é¦–â€ã€‚</li>
        <li>æ•°æ®ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨çš„ <code>localStorage</code>ï¼Œä¹Ÿå¯å¯¼å…¥/å¯¼å‡º JSON æ–‡ä»¶ã€‚</li>
      </ul>
    </details>
  </div>
</div>

<py-script>
from js import document, window, Blob, URL, FileReader
import json, random
from datetime import datetime

KEY_SONGS = "blindbox_songs"
KEY_MAP = "blindbox_mapping"
KEY_TIME = "blindbox_last_shuffle"

def _get_local(key, default=None):
    v = window.localStorage.getItem(key)
    if v is None:
        return default
    try:
        return json.loads(v)
    except Exception:
        return default

def _set_local(key, pyobj):
    window.localStorage.setItem(key, json.dumps(pyobj))

def load_songs():
    data = _get_local(KEY_SONGS, [])
    # ä¿è¯æ˜¯å»é‡åçš„å­—ç¬¦ä¸²åˆ—è¡¨
    uniq = []
    seen = set()
    for x in data:
        s = str(x).strip()
        k = s.lower()
        if s and k not in seen:
            uniq.append(s)
            seen.add(k)
    return uniq

def save_songs(songs):
    # ä¿å­˜å¹¶åŒæ­¥ UI
    _set_local(KEY_SONGS, songs)
    render_song_count()
    render_delete_list()
    # æ­Œå•å˜åŒ–åéœ€è¦é‡ç½®/ä¿®æ­£æ˜ å°„
    fix_or_reshuffle_mapping()

def get_mapping():
    return _get_local(KEY_MAP, [])

def set_mapping(mapping):
    _set_local(KEY_MAP, mapping)

def get_last_shuffle():
    return _get_local(KEY_TIME, None)

def set_last_shuffle(ts_str):
    _set_local(KEY_TIME, ts_str)

def now_str():
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def reshuffle_mapping():
    songs = load_songs()
    n = len(songs)
    mapping = list(range(n))
    random.shuffle(mapping)
    set_mapping(mapping)
    set_last_shuffle(now_str())
    render_meta()

def fix_or_reshuffle_mapping():
    # è‹¥æ˜ å°„ä¸å­˜åœ¨æˆ–é•¿åº¦ä¸æ­Œå•ä¸ä¸€è‡´ï¼Œåˆ™æ´—ç‰Œ
    songs = load_songs()
    mapping = get_mapping()
    if not mapping or len(mapping) != len(songs):
        reshuffle_mapping()
    else:
        render_meta()

def render_meta():
    count_el = document.getElementById("song-count")
    last_el = document.getElementById("last-shuffle")
    songs = load_songs()
    count_el.innerText = str(len(songs))
    last = get_last_shuffle() or "â€”"
    last_el.innerText = last

def render_song_count():
    count_el = document.getElementById("song-count")
    count_el.innerText = str(len(load_songs()))

def render_delete_list():
    sel = document.getElementById("delete-select")
    # æ¸…ç©º
    while sel.firstChild:
        sel.removeChild(sel.firstChild)
    for i, name in enumerate(load_songs()):
        opt = document.createElement("option")
        opt.value = str(i)
        opt.text = name
        sel.appendChild(opt)

def add_single():
    inp = document.getElementById("single-title")
    name = inp.value.strip()
    if not name:
        return
    songs = load_songs()
    keyset = set(x.lower() for x in songs)
    if name.lower() not in keyset:
        songs.append(name)
        songs.sort(key=lambda s: s.lower())
        save_songs(songs)
    inp.value = ""

def add_bulk():
    ta = document.getElementById("bulk-titles")
    raw = ta.value
    items = []
    for line in raw.splitlines():
        for part in line.split(","):
            s = part.strip()
            if s:
                items.append(s)
    if not items:
        return
    songs = load_songs()
    keyset = set(x.lower() for x in songs)
    for s in items:
        if s.lower() not in keyset:
            songs.append(s)
            keyset.add(s.lower())
    songs.sort(key=lambda s: s.lower())
    save_songs(songs)
    ta.value = ""

def delete_selected():
    sel = document.getElementById("delete-select")
    indices = sorted([int(o.value) for o in sel.selectedOptions], reverse=True)
    if not indices:
        return
    songs = load_songs()
    for i in indices:
        if 0 <= i < len(songs):
            songs.pop(i)
    save_songs(songs)

def open_box_by_number():
    res = document.getElementById("result")
    inp = document.getElementById("pick-number")
    try:
        n = int(inp.value)
    except Exception:
        res.innerText = "è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—ã€‚"
        return
    songs = load_songs()
    if not songs:
        res.innerText = "æ­Œå•ä¸ºç©ºã€‚"
        return
    if n < 1 or n > len(songs):
        res.innerText = "æ•°å­—è¶…å‡ºèŒƒå›´ã€‚"
        return
    fix_or_reshuffle_mapping()
    mapping = get_mapping()
    name = songs[mapping[n-1]]
    res.innerText = f"ğŸ‰ ä½ çš„ç›²ç›’æ˜¯ï¼š{name}"

def open_random():
    res = document.getElementById("result")
    songs = load_songs()
    if not songs:
        res.innerText = "æ­Œå•ä¸ºç©ºã€‚"
        return
    fix_or_reshuffle_mapping()
    mapping = get_mapping()
    pick = random.randint(1, len(songs))
    name = songs[mapping[pick-1]]
    res.innerText = f"ğŸ‰ éšæœºæŠ½åˆ°ï¼š{name}ï¼ˆç¼–å· {pick}ï¼‰"
    document.getElementById("pick-number").value = str(pick)

def export_json():
    songs = load_songs()
    data = {"songs": songs}
    blob = Blob.new([json.dumps(data, ensure_ascii=False, indent=2)], { "type": "application/json" })
    url = URL.createObjectURL(blob)
    a = document.createElement("a")
    a.href = url
    a.download = "songs.json"
    a.click()
    URL.revokeObjectURL(url)

def import_json(evt):
    file = evt.target.files[0] if evt.target.files.length > 0 else None
    if not file:
        return
    reader = FileReader.new()
    def onload(_):
        try:
            data = json.loads(reader.result)
            if isinstance(data, dict) and "songs" in data and isinstance(data["songs"], list):
                songs = [str(x) for x in data["songs"]]
            elif isinstance(data, list):
                songs = [str(x) for x in data]
            else:
                window.alert("JSON æ ¼å¼ä¸æ­£ç¡®ï¼šåº”ä¸º {\"songs\":[...]} æˆ– [...].")
                return
            # å»é‡ & æ’åº
            norm = []
            seen = set()
            for s in songs:
                s2 = s.strip()
                k = s2.lower()
                if s2 and k not in seen:
                    norm.append(s2)
                    seen.add(k)
            norm.sort(key=lambda s: s.lower())
            save_songs(norm)
        except Exception as e:
            window.alert(f"å¯¼å…¥å¤±è´¥ï¼š{e}")
    reader.onload = onload
    reader.readAsText(file, "utf-8")

# äº‹ä»¶ç»‘å®š
def bind():
    document.getElementById("btn-add-single").addEventListener("click", lambda evt: add_single())
    document.getElementById("btn-add-bulk").addEventListener("click", lambda evt: add_bulk())
    document.getElementById("btn-delete").addEventListener("click", lambda evt: delete_selected())
    document.getElementById("btn-open").addEventListener("click", lambda evt: open_box_by_number())
    document.getElementById("btn-random").addEventListener("click", lambda evt: open_random())
    document.getElementById("btn-shuffle").addEventListener("click", lambda evt: reshuffle_mapping())
    document.getElementById("btn-export").addEventListener("click", lambda evt: export_json())
    document.getElementById("import-file").addEventListener("change", import_json)

def render_on_load():
    save_songs(load_songs())  # å½’ä¸€åŒ–å¹¶æ¸²æŸ“
    fix_or_reshuffle_mapping()
    render_delete_list()

bind()
render_on_load()
</py-script>
</body>
</html>
