<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç›²ç›’æ­Œå•ï¼ˆè´¦å·ç‰ˆ Â· Supabaseï¼‰</title>
  <style>
    :root { --gap: 12px; --radius: 14px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:#0f172a; color:#e2e8f0; }
    .wrap { max-width: 880px; margin: 0 auto; padding: 20px 14px 80px; }
    h1 { font-size: 22px; margin: 8px 0 10px; }
    .row { display: grid; grid-template-columns: 1fr; gap: var(--gap); }
    @media (min-width: 720px) { .row-2 { grid-template-columns: 1fr 1fr; } }
    .card { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:14px; margin-top:12px; }
    .flex { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size: 14px; opacity:.9; margin-bottom:6px; display:block; }
    input[type="text"], input[type="email"], input[type="password"], input[type="number"], textarea, select {
      width: 100%; background:#0b1220; color:#e2e8f0; border:1px solid #233044; border-radius: 10px; padding:10px; outline:none;
    }
    textarea { min-height: 110px; resize: vertical; }
    button { background:#2563eb; color:#fff; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; }
    button.secondary { background:#374151; }
    button.warn { background:#dc2626; }
    .muted { color:#94a3b8; font-size:13px; }
    .pill { display:inline-block;background:#0b1220;border:1px solid #233044;border-radius:999px;padding:4px 10px;font-size:12px;color:#9fb7d3 }
    .spacer { height:6px; }
    .success { color:#34d399 }
    .hidden { display:none !important; }
  </style>
  <!-- Supabase JS SDK v2ï¼ˆCDNï¼‰ -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <h1>ğŸµ ç›²ç›’æ­Œå•ï¼ˆè´¦å·ç‰ˆï¼‰</h1>

  <!-- ç™»å½•åŒº -->
  <div class="card">
    <div class="row row-2">
      <div>
        <label for="email">é‚®ç®±</label>
        <input id="email" type="email" placeholder="user@example.com" />
      </div>
      <div>
        <label for="password">å¯†ç </label>
        <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
      </div>
    </div>
    <div class="spacer"></div>
    <div class="flex">
      <button id="btn-login" type="button">ç™»å½•</button>
      <button id="btn-logout" type="button" class="secondary">ç™»å‡º</button>
      <div class="muted" id="auth-info">æœªç™»å½•</div>
    </div>

    <!-- ç®¡ç†å‘˜ä¸“ç”¨ï¼šåˆ‡æ¢è¢«ç®¡ç†çš„ç”¨æˆ· -->
    <div id="admin-panel" class="hidden">
      <div class="spacer"></div>
      <label for="user-select">åˆ‡æ¢ç”¨æˆ·ï¼ˆç®¡ç†å‘˜ä»£ä¸ºç®¡ç†ï¼‰</label>
      <select id="user-select"></select>
    </div>
  </div>

  <!-- ä¿¡æ¯æ¡ -->
  <div class="card">
    <div class="flex">
      <div class="pill">æ­Œæ›²æ•°ï¼š<span id="song-count">0</span></div>
      <div class="pill">æœ€è¿‘æ´—ç‰Œï¼š<span id="last-shuffle">â€”</span></div>
      <div class="pill">å½“å‰èº«ä»½ï¼š<span id="role-badge">è®¿å®¢</span></div>
    </div>
    <div id="result" class="success"></div>
  </div>

  <!-- ç›²ç›’æ“ä½œï¼ˆæ‰€æœ‰ç™»å½•ç”¨æˆ·å¯è§ï¼‰ -->
  <div class="card">
    <div class="row row-2">
      <div>
        <label for="pick-number">è¾“å…¥ä¸€ä¸ªæ•°å­—ï¼ˆ1..Nï¼‰å¼€ç›²ç›’</label>
        <input id="pick-number" type="number" min="1" value="1" />
      </div>
      <div class="flex">
        <button id="btn-open" type="button">æ‰“å¼€ç›²ç›’</button>
        <button id="btn-random" type="button" class="secondary">éšæœºæŠ½ä¸€é¦–</button>
        <button id="btn-shuffle" type="button">é‡æ–°æ´—ç‰Œ</button>
        <button id="btn-sync" type="button" class="secondary">ä»äº‘ç«¯åˆ·æ–°</button>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘åŒºï¼šç®¡ç†å‘˜ & æœ¬äººå¯è§ï¼ˆå¦‚æœä½ æƒ³è®©æ™®é€šç”¨æˆ·å®Œå…¨ä¸èƒ½ç¼–è¾‘ï¼ŒæŠŠ refreshVisibility é‡Œæ¡ä»¶æ”¹æˆä»… isAdmin()ï¼‰ -->
  <div id="edit-section" class="card hidden">
    <div class="row row-2">
      <div>
        <label for="single-title">æ·»åŠ å•æ›²</label>
        <input id="single-title" type="text" placeholder="ä¾‹å¦‚ï¼šå‘¨æ°ä¼¦ - æ™´å¤©" />
        <div class="spacer"></div>
        <button id="btn-add-single" type="button">æ·»åŠ </button>
        <div class="muted">è‡ªåŠ¨å»é‡ï¼›ä¸åŒºåˆ†å¤§å°å†™ã€‚</div>
      </div>
      <div>
        <label for="bulk-titles">æ‰¹é‡æ·»åŠ ï¼ˆæ¯è¡Œæˆ–ç”¨é€—å·åˆ†éš”ï¼‰</label>
        <textarea id="bulk-titles" placeholder="æ­ŒåA&#10;æ­ŒåB, æ­ŒåC"></textarea>
        <div class="spacer"></div>
        <button id="btn-add-bulk" type="button">æ‰¹é‡æ·»åŠ </button>
      </div>
    </div>

    <div class="spacer"></div>
    <label for="delete-select">åˆ é™¤æ­Œæ›²ï¼ˆå¯å¤šé€‰ï¼‰</label>
    <select id="delete-select" multiple size="8"></select>
    <div class="spacer"></div>
    <button id="btn-delete" type="button" class="warn">åˆ é™¤æ‰€é€‰</button>

    <div class="row row-2">
      <div>
        <label>å¯¼å‡º JSON</label>
        <button id="btn-export" type="button" class="secondary">å¯¼å‡º songs.json</button>
      </div>
      <div>
        <label for="import-file">å¯¼å…¥ JSON</label>
        <input id="import-file" type="file" accept="application/json" />
      </div>
    </div>
  </div>
</div>

<script>
(async () => {
  "use strict";

  // === åœ¨æ­¤ç²˜è´´ä½ çš„é¡¹ç›®ä¿¡æ¯ï¼ˆå¿…å¡«ï¼‰ ===
  const SUPABASE_URL = 'https://steopnqdsgfrofwkvwnv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0ZW9wbnFkc2dmcm9md2t2d252Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTYzOTYsImV4cCI6MjA3NTM5MjM5Nn0.TOJulORFvVr2eX0qLO287x9kjn3wvqAjK68WC2eISFU';
  const ADMIN_UID = '6ad49ae6-827c-4c8b-b9cd-8aa5c4034221';

  // Supabase init
  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // çŠ¶æ€
  let currentUser = null;     // å½“å‰ç™»å½•è€… { id, email }
  let actingUserId = null;    // æ­£åœ¨æ“ä½œçš„ç”¨æˆ·ï¼ˆç®¡ç†å‘˜å¯åˆ‡æ¢ï¼‰
  let songs = [];             // æ­Œå•
  let mapping = [];           // æ˜ å°„
  let lastShuffle = null;

  // DOM å¿«æ·
  const $ = id => document.getElementById(id);
  const setText = (id, v) => $(id).textContent = v;
  const showResult = msg => setText('result', msg);

  // èº«ä»½/å¯è§æ€§
  const isAdmin = () => currentUser && currentUser.id === ADMIN_UID;
  const refreshVisibility = () => {
    setText('role-badge', isAdmin() ? 'ç®¡ç†å‘˜' : currentUser ? 'ç”¨æˆ·' : 'è®¿å®¢');
    const editingOwn = currentUser && actingUserId === currentUser.id;
    const showEdit = isAdmin() || editingOwn; // è‹¥æƒ³ç¦ç”¨æ™®é€šç”¨æˆ·ç¼–è¾‘ï¼šæ”¹æˆ const showEdit = isAdmin();
    $('edit-section').classList.toggle('hidden', !showEdit);
    $('admin-panel').classList.toggle('hidden', !isAdmin());
  };

  // æ¸²æŸ“
  function renderMeta() {
    setText('song-count', String(songs.length));
    setText('last-shuffle', lastShuffle ? new Date(lastShuffle).toLocaleString() : 'â€”');
  }
  function renderDeleteList() {
    const sel = $('delete-select'); sel.innerHTML = '';
    songs.forEach((name, i) => {
      const opt = document.createElement('option');
      opt.value = String(i); opt.textContent = name; sel.appendChild(opt);
    });
  }

  // å–/å­˜äº‘ç«¯
  async function fetchOrCreatePlaylist(userId) {
    const { data, error } = await supabase
      .from('playlists')
      .select('songs, mapping, last_shuffle')
      .eq('user_id', userId)
      .maybeSingle();
    if (error && error.code !== 'PGRST116') throw error;
    if (!data) {
      const payload = { user_id: userId, songs: [], mapping: [], last_shuffle: null };
      const { error: insErr } = await supabase.from('playlists').insert(payload);
      if (insErr) throw insErr;
      return payload;
    }
    return data;
  }
  async function savePlaylist(userId, nextSongs, nextMapping, nextLastShuffle) {
    const payload = {
      songs: nextSongs, mapping: nextMapping,
      last_shuffle: nextLastShuffle || null, updated_at: new Date().toISOString()
    };
    const { error } = await supabase.from('playlists').update(payload).eq('user_id', userId);
    if (error) throw error;
  }

  // ç®¡ç†å‘˜ï¼šæ„å»ºç”¨æˆ·ä¸‹æ‹‰ï¼ˆåŸºäº playlists ä¸­å·²æœ‰è®°å½•ï¼‰
  async function buildAdminUserList() {
    const { data, error } = await supabase.from('playlists').select('user_id');
    if (error) throw error;
    const ids = Array.from(new Set((data||[]).map(r => r.user_id)));
    const sel = $('user-select'); sel.innerHTML = '';
    const me = document.createElement('option');
    me.value = currentUser.id; me.textContent = `è‡ªå·± (${currentUser.id.slice(0,8)}â€¦)`;
    sel.appendChild(me);
    for (const id of ids) {
      if (id === currentUser.id) continue;
      const opt = document.createElement('option');
      opt.value = id; opt.textContent = id; sel.appendChild(opt);
    }
    actingUserId = sel.value;
  }

  // æ´—ç‰Œä¸æ˜ å°„
  function reshuffle() {
    const n = songs.length;
    mapping = Array.from({length:n}, (_,i)=>i);
    for (let i=n-1;i>0;i--) { const j = Math.floor(Math.random()*(i+1)); [mapping[i],mapping[j]]=[mapping[j],mapping[i]]; }
    lastShuffle = new Date().toISOString();
    renderMeta();
  }
  function ensureMapping() {
    if (!mapping || mapping.length !== songs.length) reshuffle(); else renderMeta();
  }

  // æ“ä½œ
  async function openByNumber() {
    const n = parseInt($('pick-number').value,10);
    if (!songs.length) { showResult('æ­Œå•ä¸ºç©ºã€‚'); return; }
    if (!Number.isInteger(n) || n<1 || n>songs.length) { showResult('æ•°å­—è¶…å‡ºèŒƒå›´ã€‚'); return; }
    ensureMapping(); showResult(`ğŸ‰ ä½ çš„ç›²ç›’æ˜¯ï¼š${songs[mapping[n-1]]}`);
  }
  async function openRandom() {
    if (!songs.length) { showResult('æ­Œå•ä¸ºç©ºã€‚'); return; }
    ensureMapping();
    const pick = Math.floor(Math.random()*songs.length)+1;
    showResult(`ğŸ‰ éšæœºæŠ½åˆ°ï¼š${songs[mapping[pick-1]]}ï¼ˆç¼–å· ${pick}ï¼‰`);
    $('pick-number').value = String(pick);
  }
  async function doShuffle() { reshuffle(); await savePlaylist(actingUserId, songs, mapping, lastShuffle); }
  async function addSingle() {
    const name = ($('single-title').value||'').trim(); if (!name) return;
    const set = new Set(songs.map(s=>s.toLowerCase()));
    if (!set.has(name.toLowerCase())) {
      songs.push(name); songs.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
      ensureMapping(); await savePlaylist(actingUserId, songs, mapping, lastShuffle); renderDeleteList();
    }
    $('single-title').value = '';
  }
  async function addBulk() {
    const raw = $('bulk-titles').value||''; const parts = raw.split(/\n|,/).map(s=>s.trim()).filter(Boolean);
    if (!parts.length) return;
    const set = new Set(songs.map(s=>s.toLowerCase()));
    for (const s of parts) if (!set.has(s.toLowerCase())) { songs.push(s); set.add(s.toLowerCase()); }
    songs.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
    ensureMapping(); await savePlaylist(actingUserId, songs, mapping, lastShuffle); renderDeleteList();
    $('bulk-titles').value = '';
  }
  async function delSelected() {
    const sel = $('delete-select');
    const idxs = Array.from(sel.selectedOptions).map(o=>parseInt(o.value,10)).sort((a,b)=>b-a);
    if (!idxs.length) return;
    for (const i of idxs) if (i>=0 && i<songs.length) songs.splice(i,1);
    ensureMapping(); await savePlaylist(actingUserId, songs, mapping, lastShuffle); renderDeleteList();
  }
  function exportJSON() {
    const data = JSON.stringify({ songs }, null, 2);
    const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'songs.json'; a.click(); URL.revokeObjectURL(url);
  }
  async function importJSONFile(evt) {
    const file = evt.target.files && evt.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const data = JSON.parse(String(reader.result||"{}"));
        let arr = []; if (Array.isArray(data)) arr = data.map(String);
        else if (data && Array.isArray(data.songs)) arr = data.songs.map(String);
        else { alert('JSON æ ¼å¼ä¸æ­£ç¡®ï¼šåº”ä¸º {"songs":[...]} æˆ– [...].'); return; }
        // å»é‡ + æ’åº
        const uniq = []; const seen = new Set();
        for (const s of arr) { const t=(s||'').trim(), k=t.toLowerCase(); if (t && !seen.has(k)) { uniq.push(t); seen.add(k); } }
        uniq.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
        songs = uniq; ensureMapping(); await savePlaylist(actingUserId, songs, mapping, lastShuffle); renderDeleteList();
      } catch (e) { alert('å¯¼å…¥å¤±è´¥ï¼š' + e); }
      finally { evt.target.value = ''; }
    };
    reader.readAsText(file, 'utf-8');
  }
  async function syncFromCloud() {
    const data = await fetchOrCreatePlaylist(actingUserId);
    songs = (data.songs||[]).map(String); mapping = Array.isArray(data.mapping)?data.mapping:[]; lastShuffle = data.last_shuffle;
    renderMeta(); renderDeleteList();
  }

  // ç™»å½•/ç™»å‡º
  async function login() {
    const email = $('email').value.trim(); const password = $('password').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) { alert('ç™»å½•å¤±è´¥ï¼š' + error.message); return; }
    currentUser = data.user; actingUserId = currentUser.id;
    setText('auth-info', `å·²ç™»å½•ï¼š${currentUser.email}`); if (isAdmin()) { $('admin-panel').classList.remove('hidden'); await buildAdminUserList(); }
    refreshVisibility(); await syncFromCloud();
  }
  async function logout() {
    await supabase.auth.signOut(); currentUser=null; actingUserId=null; songs=[]; mapping=[]; lastShuffle=null;
    setText('auth-info','æœªç™»å½•'); refreshVisibility(); renderMeta(); renderDeleteList(); showResult('');
  }
  async function onSelectUser() { if (!isAdmin()) return; actingUserId = $('user-select').value; await syncFromCloud(); refreshVisibility(); }

  // ç»‘å®š
  $('btn-login').addEventListener('click', login);
  $('btn-logout').addEventListener('click', logout);
  $('btn-open').addEventListener('click', openByNumber);
  $('btn-random').addEventListener('click', openRandom);
  $('btn-shuffle').addEventListener('click', () => doShuffle());
  $('btn-sync').addEventListener('click', syncFromCloud);

  $('btn-add-single').addEventListener('click', addSingle);
  $('btn-add-bulk').addEventListener('click', addBulk);
  $('btn-delete').addEventListener('click', delSelected);
  $('btn-export').addEventListener('click', exportJSON);
  $('import-file').addEventListener('change', importJSONFile);
  $('user-select').addEventListener('change', onSelectUser);

  // æ¢å¤ä¼šè¯
  const { data: { session } } = await supabase.auth.getSession();
  if (session?.user) {
    currentUser = session.user; actingUserId = currentUser.id;
    setText('auth-info', `å·²ç™»å½•ï¼š${currentUser.email}`); if (isAdmin()) { $('admin-panel').classList.remove('hidden'); await buildAdminUserList(); }
    refreshVisibility(); await syncFromCloud();
  } else {
    refreshVisibility();
  }
})();
</script>
</body>
</html>
