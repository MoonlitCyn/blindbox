<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>盲盒歌单（纯浏览器版）</title>
  <style>
    :root { --gap: 12px; --radius: 14px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
           margin: 0; background: #0f172a; color: #e2e8f0; }
    .wrap { max-width: 840px; margin: 0 auto; padding: 20px 14px 80px; }
    h1 { font-size: 22px; margin: 8px 0 10px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: var(--radius);
            padding: 14px; margin-top: var(--gap); }
    label { font-size: 14px; opacity: .9; margin-bottom: 6px; display: block; }
    input[type="text"], input[type="number"], textarea, select {
      width: 100%; background: #0b1220; color: #e2e8f0; border: 1px solid #233044;
      border-radius: 10px; padding: 10px; outline: none;
    }
    textarea { min-height: 110px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr; gap: var(--gap); }
    @media (min-width: 720px) { .row-2 { grid-template-columns: 1fr 1fr; } }
    button {
      background: #2563eb; color: #fff; border: none; border-radius: 10px;
      padding: 10px 14px; font-weight: 600; cursor: pointer;
    }
    button.secondary { background: #374151; }
    button.warn { background: #dc2626; }
    .muted { color: #94a3b8; font-size: 13px; }
    .pill { display:inline-block;background:#0b1220;border:1px solid #233044;border-radius:999px;padding:4px 10px;font-size:12px;color:#9fb7d3 }
    .flex { display:flex; gap: var(--gap); align-items: center; flex-wrap: wrap; }
    .spacer { height: 6px; }
    .success { color:#34d399 }
    .hr { height:1px; background:#1f2937; margin: 10px 0; }
    .kbd { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
           background:#0b1220;border:1px solid #233044;border-radius:6px;padding:2px 6px;font-size:12px; }
    .num { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>🎵 盲盒歌单</h1>

  <!-- 歌曲池与控制 -->
  <div class="card">
    <div class="flex">
      <div class="pill">歌曲数：<span id="song-count" class="num">0</span></div>
      <div class="pill">最近洗牌：<span id="last-shuffle" class="num">—</span></div>
    </div>
    <div class="spacer"></div>
    <div class="row row-2">
      <div>
        <label for="pick-number">输入一个数字（1..N）开盲盒</label>
        <input id="pick-number" type="number" min="1" value="1" />
      </div>
      <div class="flex">
        <button id="btn-open" type="button">打开盲盒</button>
        <button id="btn-random" type="button" class="secondary">随机抽一首</button>
        <button id="btn-shuffle" type="button">重新洗牌</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div id="result" class="success"></div>
  </div>

  <!-- 添加/删除 -->
  <div class="row row-2">
    <div class="card">
      <label for="single-title">添加单曲</label>
      <input id="single-title" type="text" placeholder="例如：周杰伦 - 晴天" />
      <div class="spacer"></div>
      <button id="btn-add-single" type="button">添加</button>
      <div class="spacer"></div>
      <div class="muted">会自动去重；不区分大小写。</div>
    </div>
    <div class="card">
      <label for="bulk-titles">批量添加（每行或用逗号分隔）</label>
      <textarea id="bulk-titles" placeholder="歌名A&#10;歌名B, 歌名C"></textarea>
      <div class="spacer"></div>
      <button id="btn-add-bulk" type="button">批量添加</button>
    </div>
  </div>

  <div class="card">
    <label for="delete-select">删除歌曲（可多选）</label>
    <select id="delete-select" multiple size="8" aria-label="删除歌曲列表"></select>
    <div class="spacer"></div>
    <button id="btn-delete" type="button" class="warn">删除所选</button>
  </div>

<!--  &lt;!&ndash; 导入 / 导出 &ndash;&gt;-->
<!--  <div class="row row-2">-->
<!--    <div class="card">-->
<!--      <label>导出 JSON</label>-->
<!--      <button id="btn-export" type="button" class="secondary">导出 songs.json</button>-->
<!--      <div class="spacer"></div>-->
<!--      <div class="muted">格式：<span class="kbd">{&quot;songs&quot;: [&quot;歌名1&quot;, ...]}</span> 或 <span class="kbd">[&quot;歌名1&quot;, ...]</span></div>-->
<!--    </div>-->
<!--    <div class="card">-->
<!--      <label for="import-file">导入 JSON</label>-->
<!--      <input id="import-file" type="file" accept="application/json" />-->
<!--      <div class="spacer"></div>-->
<!--      <div class="muted">导入会覆盖当前歌单（会自动转换为不重复列表）。</div>-->
<!--    </div>-->
<!--  </div>-->

<!--  <div class="card">-->
<!--    <details>-->
<!--      <summary>使用说明</summary>-->
<!--      <div class="hr"></div>-->
<!--      <ul>-->
<!--        <li>点击“重新洗牌”会随机打乱 <b>数字 1..N</b> 与 <b>歌名</b> 的对应关系，并记录时间。</li>-->
<!--        <li>输入数字开盲盒；或点“随机抽一首”。</li>-->
<!--        <li>数据保存在本机浏览器的 <code>localStorage</code>，也可导入/导出 JSON 文件。</li>-->
<!--      </ul>-->
<!--    </details>-->
<!--  </div>-->
<!--</div>-->

<script>
(function () {
  "use strict";

  // ---- 本地存储键 ----
  const KEY_SONGS = "blindbox_songs";
  const KEY_MAP   = "blindbox_mapping";
  const KEY_TIME  = "blindbox_last_shuffle";


  // ---- 工具 ----
  function getLocal(key, defVal) {
    try {
      const v = localStorage.getItem(key);
      return v == null ? defVal : JSON.parse(v);
    } catch {
      return defVal;
    }
  }
  function setLocal(key, val) {
    localStorage.setItem(key, JSON.stringify(val));
  }
  function nowStr() {
    const d = new Date();
    const pad = n => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  // ---- 数据层 ----
  function loadSongs() {
    let data = getLocal(KEY_SONGS, []);
    if ((!data || data.length === 0) && DEFAULT_SONGS.length) {
      setLocal(KEY_SONGS, DEFAULT_SONGS);
      data = DEFAULT_SONGS;
    }
    const uniq = [];
    const seen = new Set();
    for (const x of data) {
      const s = String(x).trim();
      const k = s.toLowerCase();
      if (s && !seen.has(k)) { uniq.push(s); seen.add(k); }
    }
    return uniq;
  }
  function saveSongs(songs) {
    setLocal(KEY_SONGS, songs);
    renderSongCount();
    renderDeleteList();
    fixOrReshuffleMapping();
  }

  function getMapping() { return getLocal(KEY_MAP, []); }
  function setMapping(m) { setLocal(KEY_MAP, m); }
  function getLastShuffle() { return getLocal(KEY_TIME, null); }
  function setLastShuffle(s) { setLocal(KEY_TIME, s); }

  // ---- 逻辑 ----
  function reshuffleMapping() {
    const n = loadSongs().length;
    const mapping = Array.from({length: n}, (_, i) => i);
    for (let i = n - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [mapping[i], mapping[j]] = [mapping[j], mapping[i]];
    }
    setMapping(mapping);
    setLastShuffle(nowStr());
    renderMeta();
  }

  function fixOrReshuffleMapping() {
    const songs = loadSongs();
    const mapping = getMapping();
    if (!mapping || mapping.length !== songs.length) reshuffleMapping();
    else renderMeta();
  }

  // ---- 渲染 ----
  function renderMeta() {
    document.getElementById("song-count").innerText = String(loadSongs().length);
    document.getElementById("last-shuffle").innerText = getLastShuffle() || "—";
  }
  function renderSongCount() {
    document.getElementById("song-count").innerText = String(loadSongs().length);
  }
  function renderDeleteList() {
    const sel = document.getElementById("delete-select");
    while (sel.firstChild) sel.removeChild(sel.firstChild);
    loadSongs().forEach((name, i) => {
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = name;
      sel.appendChild(opt);
    });
  }

  // ---- 交互 ----
  function addSingle() {
    const inp = document.getElementById("single-title");
    const name = (inp.value || "").trim();
    if (!name) return;
    const songs = loadSongs();
    const set = new Set(songs.map(s => s.toLowerCase()));
    if (!set.has(name.toLowerCase())) {
      songs.push(name);
      songs.sort((a,b) => a.toLowerCase().localeCompare(b.toLowerCase()));
      saveSongs(songs);
    }
    inp.value = "";
  }

  function addBulk() {
    const ta = document.getElementById("bulk-titles");
    const raw = ta.value || "";
    const parts = raw.split(/\n|,/).map(s => s.trim()).filter(Boolean);
    if (parts.length === 0) return;
    const songs = loadSongs();
    const set = new Set(songs.map(s => s.toLowerCase()));
    for (const s of parts) {
      if (!set.has(s.toLowerCase())) {
        songs.push(s);
        set.add(s.toLowerCase());
      }
    }
    songs.sort((a,b) => a.toLowerCase().localeCompare(b.toLowerCase()));
    saveSongs(songs);
    ta.value = "";
  }

  function deleteSelected() {
    const sel = document.getElementById("delete-select");
    const idxs = Array.from(sel.selectedOptions).map(o => parseInt(o.value, 10)).sort((a,b)=>b-a);
    if (idxs.length === 0) return;
    const songs = loadSongs();
    for (const i of idxs) {
      if (i >=0 && i < songs.length) songs.splice(i, 1);
    }
    saveSongs(songs);
  }

  function openBoxByNumber() {
    const res = document.getElementById("result");
    const val = document.getElementById("pick-number").value;
    const n = parseInt(val, 10);
    const songs = loadSongs();
    if (!songs.length) { res.textContent = "歌单为空。"; return; }
    if (!Number.isInteger(n) || n < 1 || n > songs.length) { res.textContent = "数字超出范围。"; return; }
    fixOrReshuffleMapping();
    const mapping = getMapping();
    res.textContent = `🎉 你的盲盒是：${songs[mapping[n-1]]}`;
  }

  function openRandom() {
    const res = document.getElementById("result");
    const songs = loadSongs();
    if (!songs.length) { res.textContent = "歌单为空。"; return; }
    fixOrReshuffleMapping();
    const mapping = getMapping();
    const pick = Math.floor(Math.random() * songs.length) + 1;
    res.textContent = `🎉 随机抽到：${songs[mapping[pick-1]]}（编号 ${pick}）`;
    document.getElementById("pick-number").value = String(pick);
  }

  function exportJSON() {
    const songs = loadSongs();
    const data = JSON.stringify({ songs }, null, 2);
    const blob = new Blob([data], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "songs.json"; a.click();
    URL.revokeObjectURL(url);
  }

  function importJSONFile(evt) {
    const file = evt.target.files && evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(String(reader.result || "{}"));
        let arr = [];
        if (Array.isArray(data)) arr = data.map(String);
        else if (data && Array.isArray(data.songs)) arr = data.songs.map(String);
        else { alert('JSON 格式不正确：应为 {"songs":[...]} 或 [...].'); return; }
        // 去重 + 排序
        const uniq = [];
        const seen = new Set();
        for (const s of arr) {
          const x = (s || "").trim();
          const k = x.toLowerCase();
          if (x && !seen.has(k)) { uniq.push(x); seen.add(k); }
        }
        uniq.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
        saveSongs(uniq);
      } catch (e) {
        alert("导入失败：" + e);
      } finally {
        evt.target.value = ""; // 允许重复导入同一文件
      }
    };
    reader.readAsText(file, "utf-8");
  }

  // ---- 绑定事件 ----
  function bind() {
    document.getElementById("btn-open").addEventListener("click", openBoxByNumber);
    document.getElementById("btn-random").addEventListener("click", openRandom);
    document.getElementById("btn-shuffle").addEventListener("click", reshuffleMapping);
    document.getElementById("btn-add-single").addEventListener("click", addSingle);
    document.getElementById("btn-add-bulk").addEventListener("click", addBulk);
    document.getElementById("btn-delete").addEventListener("click", deleteSelected);
    document.getElementById("btn-export").addEventListener("click", exportJSON);
    document.getElementById("import-file").addEventListener("change", importJSONFile);
  }

  // ---- 初始化 ----
  function init() {
    saveSongs(loadSongs()); // 归一化并渲染
    fixOrReshuffleMapping();
    renderDeleteList();
    bind();
  }

  // 等 DOM 就绪
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>
</body>
</html>
